extends ../../layouts/default.pug
include ../../mixin/flash.pug

block main
  +alert-success(5000)
  +alert-error(5000)

  - const formattedPrice = product.price?.toLocaleString('vi-VN')
  - const discountedPrice = product.price * (1 - product.discountPercentage / 100)
  - const formattedDiscountedPrice = discountedPrice?.toLocaleString('vi-VN')
  - const images = product.thumbnail || []

  .container.my-5
    .row.justify-content-center
      .col-lg-10

        // VÃ™NG áº¢NH + THÃ”NG TIN
        .bg-white.border.rounded-4.p-4.mb-4(style="border-radius: 1rem !important;")
          .row
            // VÃ™NG áº¢NH
            .col-md-6
              if (images.length > 0)
                img#mainImage(src=images[0], alt=product.title, class="img-fluid rounded-4 border w-100 mb-3", style="border-radius: 1rem !important; cursor: zoom-in;")
              else
                img#mainImage(src="/images/no-image.png", alt="No Image", class="img-fluid rounded-4 border w-100 mb-3", style="border-radius: 1rem !important; cursor: zoom-in;")

              if (images.length > 1)
                .d-flex.flex-wrap.gap-2
                  each imgUrl, index in images
                    img.thumbnail-img(src=imgUrl, data-index=index, alt="áº¢nh phá»¥", class="img-thumbnail rounded-3", style="width: 60px; height: 60px; object-fit: cover; cursor: pointer; border-radius: 0.75rem !important;")

              // LightGallery container (áº©n, dÃ¹ng Ä‘á»ƒ táº¡o lightbox)
              #lightGallery(style="display: none")

            // VÃ™NG THÃ”NG TIN
            .col-md-6
              .bg-white.border.rounded-4.p-4(style="border-radius: 1rem !important;")
                if (product.title)
                  h2.mb-3.text-primary #{product.title}

                if (product.price)
                  p.mb-2
                    span.fw-bold GiÃ¡ gá»‘c:
                    del.text-muted.ms-2 #{formattedPrice}Ä‘

                if (product.discountPercentage)
                  p.mb-2
                    span.fw-bold Giáº£m giÃ¡:
                    | #{product.discountPercentage}%

                  p.mb-2
                    span.fw-bold.text-danger GiÃ¡ khuyáº¿n mÃ£i:
                    | #{formattedDiscountedPrice}Ä‘

                if (product.stock)
                  p.mb-3
                    span.fw-bold CÃ²n láº¡i:
                    | #{product.stock} sáº£n pháº©m

                form(method="POST", action=`/cart/add/${product._id}`)
                  input(type="hidden", name="quantity", value="1")
                  button.btn.btn-outline-success.rounded-3(type="submit", style="border-radius: 1rem !important;") THÃŠM VÃ€O GIá»Ž HÃ€NG

        // VÃ™NG QUÃ€ Táº¶NG
        .bg-white.border.rounded-4.p-4.mb-4(style="border-radius: 1rem !important;")
          h5.fw-bold.text-success ðŸŽ Báº N Sáº¼ NHáº¬N ÄÆ¯á»¢C
          ul.mb-0
            li 1x TÃºi Ä‘eo lÆ°ng/ Balo laptop 15.6 inch
            li 1x Bá»™ chia/ Hub USB-C 5 in 1 há»— trá»£ 4K
            li 1x MÃ£ Æ°u Ä‘Ã£i dÃ¡n mÃ n hÃ¬nh

        // VÃ™NG MÃ” Táº¢
        if (product.description)
          .bg-white.border.rounded-4.p-4.mb-4(style="border-radius: 1rem !important;")
            h5.mb-3.text-secondary ðŸ“ MÃ´ táº£ sáº£n pháº©m
            p.lead !{product.description}

        // VÃ™NG ÄÃNH GIÃ
        .bg-white.border.rounded-4.p-4(style="border-radius: 1rem !important;")
          h5.mb-4.text-primary â­ ÄÃ¡nh giÃ¡ & BÃ¬nh luáº­n

          .mb-3
            strong Nguyá»…n VÄƒn A
            span.ms-2.text-warning â˜…â˜…â˜…â˜…â˜…
            p.mb-1.mt-1 Sáº£n pháº©m ráº¥t tá»‘t, giao hÃ ng nhanh!

          .mb-3
            strong Tráº§n Thá»‹ B
            span.ms-2.text-warning â˜…â˜…â˜…â˜…â˜†
            p.mb-1.mt-1 Sáº£n pháº©m á»•n so vá»›i giÃ¡ tiá»n.

          .mb-3
            strong LÃª C
            span.ms-2.text-warning â˜…â˜…â˜…â˜†â˜†
            p.mb-1.mt-1 BÃ¬nh thÆ°á»ng, khÃ´ng cÃ³ gÃ¬ Ä‘áº·c biá»‡t.

  // ÄÆ°a biáº¿n áº£nh xuá»‘ng JS
  script.
    const productImages = !{JSON.stringify(images)};

  // LightGallery CSS + JS
  link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lightgallery-bundle.min.css")
  script(src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/lightgallery.min.js")

  // LightGallery khá»Ÿi táº¡o & xá»­ lÃ½ thumbnail
  script.
    document.addEventListener('DOMContentLoaded', function () {
      const mainImage = document.getElementById('mainImage');
      const thumbnails = document.querySelectorAll('.thumbnail-img');
      const lightboxContainer = document.getElementById('lightGallery');

      thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', () => {
          const src = thumbnail.getAttribute('src');
          if (mainImage) {
            mainImage.setAttribute('src', src);
          }
        });
      });

      if (mainImage && lightboxContainer && productImages.length > 0) {
        mainImage.addEventListener('click', () => {
          lightboxContainer.innerHTML = '';
          
          productImages.forEach(img => {
            const a = document.createElement('a');
            a.href = img;
            a.dataset.subHtml = "";
            lightboxContainer.appendChild(a);
          });

          // KÃ­ch hoáº¡t LightGallery vÃ  cho phÃ©p zoom áº£nh
          lightGallery(lightboxContainer, {
            dynamic: true,
            dynamicEl: productImages.map(img => ({ src: img })),
            zoom: true // KÃ­ch hoáº¡t zoom
          });
        });
      }
    });
