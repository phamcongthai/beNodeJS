extends ../../layouts/default.pug
include ../../mixin/flash.pug

block main
  +alert-success(5000)
  +alert-error(5000)

  - const formattedPrice = product.price?.toLocaleString('vi-VN')
  - const discountedPrice = product.price * (1 - product.discountPercentage / 100)
  - const formattedDiscountedPrice = discountedPrice?.toLocaleString('vi-VN')
  - const images = product.thumbnail || []

  .row.justify-content-center
    .col-lg-10()

      // LABEL GIAO H√ÄNG
      div(style="display: flex; gap: 12px; margin-bottom: 1.5rem;")
        span(style="background-color: #dc3545; color: white; border-radius: 50px; padding: 6px 12px; font-weight: 500; font-size: 0.9rem; display: inline-flex; align-items: center;")
          i(class="fas fa-truck-fast", style="margin-right: 8px;")
          | Mi·ªÖn ph√≠ giao h√†ng
        span(style="background-color: #dc3545; color: white; border-radius: 50px; padding: 6px 12px; font-weight: 500; font-size: 0.9rem; display: inline-flex; align-items: center;")
          i(class="fas fa-cart-shopping", style="margin-right: 8px;")
          | Thanh to√°n online

      // S·∫¢N PH·∫®M
      .bg-white.border.rounded-4.p-4.mb-4(style="box-shadow: none;")
        .row
          .col-md-6.position-relative
            if (images.length > 0)
              img#mainImage(
                src=images[0],
                alt=product.title,
                class="img-fluid rounded-4 border w-100 mb-3 drift-trigger",
                data-zoom=images[0],
                style="cursor: zoom-in; border-radius: 12px;"
              )
              // T·∫°o v√πng ch·ª©a zoom pane, c√≥ k√≠ch th∆∞·ªõc r√µ r√†ng v√† bo g√≥c
              div#zoomPane(style="width: 150px; height: 150px; border-radius: 12px; overflow: hidden; border: 1px solid #ccc; position: absolute; top: 0; right: -160px; z-index: 9999;")
            else
              img(
                src="/images/no-image.png",
                alt="No Image",
                class="img-fluid rounded-4 border w-100 mb-3"
              )
            if (images.length > 1)
              .d-flex.flex-wrap.gap-2
                each imgUrl, index in images
                  img.thumbnail-img(
                    src=imgUrl,
                    data-index=index,
                    alt="·∫¢nh ph·ª•",
                    class="img-thumbnail rounded-3",
                    style="width: 60px; height: 60px; object-fit: cover; cursor: pointer;"
                  )

          .col-md-6
            .bg-white.border.rounded-4.p-4(style="box-shadow: none;")
              if (product.title)
                h2.mb-3.text-primary #{product.title}

              if (product.price)
                p.mb-2
                  span.fw-bold Gi√° g·ªëc:
                  del.text-muted.ms-2 #{formattedPrice}ƒë

              if (product.discountPercentage)
                p.mb-2
                  span.fw-bold Gi·∫£m gi√°:
                  | #{product.discountPercentage}%
                p.mb-2
                  span.fw-bold.text-danger Gi√° khuy·∫øn m√£i:
                  | #{formattedDiscountedPrice}ƒë

              if (product.stock)
                p.mb-3
                  span.fw-bold C√≤n l·∫°i:
                  | #{product.stock} s·∫£n ph·∫©m

              form(method="POST", action=`/cart/add/${product._id}`) 
                input(type="hidden", name="quantity", value="1")
                button.btn.btn-outline-success.rounded-3(type="submit")
                  | TH√äM V√ÄO GI·ªé H√ÄNG

              p.fw-bold.text-success.mb-2 üéÅ B·∫†N S·∫º NH·∫¨N ƒê∆Ø·ª¢C
              ul.mb-3
                li 1x T√∫i ƒëeo l∆∞ng / Balo laptop
                li 1x B·ªô chia USB-C 5in1
                li 1x M√£ ∆∞u ƒë√£i d√°n m√†n h√¨nh

              if (product.description)
                h5.mb-3.text-secondary üìù M√¥ t·∫£ s·∫£n ph·∫©m
                p.lead !{product.description}

      // B√åNH LU·∫¨N
      .bg-white.border.rounded-4.p-4(style="box-shadow: none;")
        h5.mb-4.text-primary ‚≠ê ƒê√°nh gi√° & B√¨nh lu·∫≠n

        form(method="POST", action=`/comment/add/${product.slug}`)
          .mb-3
            label(for="comment") B√¨nh lu·∫≠n c·ªßa b·∫°n:
            textarea.form-control(name="comment", rows="3", required placeholder="Nh·∫≠p b√¨nh lu·∫≠n...")

          .mb-3
            label(for="rating") ƒê√°nh gi√°:
            .starability-basic
              input(type="radio", id="rate5", name="rating", value="5")
              label(for="rate5") 5 sao
              input(type="radio", id="rate4", name="rating", value="4")
              label(for="rate4") 4 sao
              input(type="radio", id="rate3", name="rating", value="3")
              label(for="rate3") 3 sao
              input(type="radio", id="rate2", name="rating", value="2")
              label(for="rate2") 2 sao
              input(type="radio", id="rate1", name="rating", value="1")
              label(for="rate1") 1 sao

          button.btn.btn-primary(type="submit") G·ª≠i b√¨nh lu·∫≠n

        if comments && comments.length > 0
          each cmt in comments
            .comment-item.d-flex.align-items-start.gap-3.mt-4.pt-3.pb-3.border-bottom
              .avatar.rounded-circle.text-white.fw-bold.d-flex.justify-content-center.align-items-center
                = (cmt.fullName || 'N')[0].toUpperCase()

              .comment-body.w-100
                .d-flex.justify-content-between.align-items-center.mb-1
                  .fw-bold #{cmt.fullName || 'Ng∆∞·ªùi d√πng'}
                  span.text-muted.fs-sm
                    - const createdAt = new Date(cmt.createdAt);
                    - const now = new Date();
                    - const daysAgo = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));
                    = isNaN(daysAgo) ? 'V·ª´a xong' : `${daysAgo} ng√†y tr∆∞·ªõc`

                .rating.mb-2
                  - for (let i = 1; i <= 5; i++)
                    if i <= cmt.rating
                      i.fas.fa-star.text-warning.me-1
                    else
                      i.far.fa-star.text-warning.me-1

                p.mb-0= cmt.comment
        else
          p.text-muted.mt-3 Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.

  // === JS ===
  script.
    document.addEventListener('DOMContentLoaded', function () {
      const productImages = !{JSON.stringify(images)};
      const mainImage = document.querySelector("#mainImage");
      const thumbnails = document.querySelectorAll(".thumbnail-img");
      const zoomPane = document.querySelector('#zoomPane');

      // Kh·ªüi t·∫°o drift l·∫ßn ƒë·∫ßu v·ªõi inlinePane: true
      let driftZoom = new Drift(mainImage, {
        paneContainer: zoomPane,
        inlinePane: true,
        containInline: true,
        hoverBoundingBox: true
      });

      thumbnails.forEach((thumb, index) => {
        thumb.addEventListener("click", () => {
          const newSrc = productImages[index];
          mainImage.src = newSrc;
          mainImage.setAttribute('data-zoom', newSrc);

          // H·ªßy drift c≈© v√† t·∫°o l·∫°i v·ªõi inlinePane: true ƒë·ªÉ zoom pane v·∫´n n·∫±m trong #zoomPane
          driftZoom.destroy();
          driftZoom = new Drift(mainImage, {
            paneContainer: zoomPane,
            inlinePane: true,
            containInline: true,
            hoverBoundingBox: true
          });
        });
      });
    });

  // === CSS ===
  style.
    .comment-item {
      border-color: #eee;
      border-radius: 12px !important;
    }

    .avatar {
      background-color: #6c757d;
      width: 45px;
      height: 45px;
      font-size: 1rem;
      border-radius: 50%;
    }

    .fs-sm {
      font-size: 0.875rem;
    }

    .rating i {
      font-size: 1rem;
    }

    .comment-body p {
      line-height: 1.5;
    }

    .drift-zoom-pane {
      width: 150px !important;
      height: 150px !important;
      border-radius: 50% !important;
      border: none !important;
      box-shadow: none !important;
      z-index: 9999 !important;
    }
    #zoomPane{
      display : none;
      border-radius: 12px;
    }

    /* M·ªçi ph·∫ßn t·ª≠ c√≥ border bo tr√≤n 12px */
    .border {
      border-radius: 12px !important;
    }

  // === TH∆Ø VI·ªÜN ===
  link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/starability/starability-all.min.css")
  script(src="https://code.jquery.com/jquery-3.6.0.min.js")
  link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/drift-zoom/dist/drift-basic.min.css")
  script(src="https://cdn.jsdelivr.net/npm/drift-zoom/dist/Drift.min.js")
